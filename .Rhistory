install.packages(caTools)
install.packages("caTools")
## load packages
library(ape)
library(phytools)
library(brms)
library(rethinking)
library(rstan)
# rstan options
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
## set working directory
setwd("//files.iem.uzh.ch/Data/Institute/Human_Ecology/ajaegg/Private/My Documents/GitHub/sex-bias-cooperation")
## read files
d<- read.csv("sexbiascoalitions.csv", header=TRUE)
trees<- read.tree("TreeBlockSexBiasCooperation.tre")
# convert trees to covariance matrix (see https://cran.r-project.org/web/packages/brms/vignettes/brms_phylogenetics.html)
A<- list()
for(i in 1:100){
A[[i]]<- vcv.phylo(trees[[i]])
}
# create consensus tree
cons.tree<- consensus.edges(trees)
A.cons<- vcv.phylo(cons.tree)
d$coalitions<- relevel(d$coalitions, ref="Unbiased")
d$Philopatry<- relevel(d$Philopatry, ref="N")
# transform predictors
d$SexDim.z<- (d$Sex_Dim-1)/sd(d$Sex_Dim) # mean = monomorphic, units = SD
# adjust prior
get_prior(coalitions ~ Food_resource_defendable + Philopatry + SexDim.z + (1|Genus_species), data = d, family = categorical(), cov_ranef = list(Genus_species = A.cons))
prior.m4<- c(
prior(normal(0,1), "Intercept", dpar="muFemalebiased"), # reasonably narrow prior (favors values from ~ -10 to 10 in log-odds space, i.e. basically 0-1 in probability space) --> no need to sample infinite space beyond that
prior(normal(0,1), "Intercept", dpar="muMalebiased"),
prior(normal(0,0.5), "b", dpar="muFemalebiased"), # same prior for all slopes
prior(normal(0,0.5), "b", dpar="muMalebiased"),
prior(cauchy(0,0.1), "sd", dpar="muFemalebiased"), # pretty strong prior on variance components because phylo variance with huge CIs
prior(cauchy(0,0.1), "sd", dpar="muMalebiased")
)
# simulate from prior to check slopes on non-categorical predictors
m4.prior<- brm(coalitions ~ Food_resource_defendable + Philopatry + SexDim.z + (1|Genus_species), data = d, family = categorical(), cov_ranef = list(Genus_species = A.cons),
prior = prior.m4, chains = 4, cores = 4, iter = 4000, warmup = 2000, control = list(adapt_delta = 0.999, max_treedepth = 15, stepsize = 0.01),
sample_prior = "only")
post_m4.prior<- posterior_samples(m4.prior)
plot(NULL, xlim=c(-3,3), ylim=c(0,1))
for(i in sample(1:nrow(post_m4.prior), 100)){
abline(logistic(post_m4.prior[i,1]),post_m4.prior[i,2], col=col.alpha("lightblue", 0.2), lwd=0.5)
}
plot(NULL, xlim=c(-3,3), ylim=c(0,1))
for(i in sample(1:nrow(post_m4.prior), 100)){
abline(post_m4.prior[i,1],post_m4.prior[i,2], col=col.alpha("lightblue", 0.2), lwd=0.5)
}
names(post_m4.prior)[1:8]
names(post_m4.prior)[1:10]
names(post_m4.prior)[1:14]
plot(NULL, xlim=c(-3,3), ylim=c(0,1))
for(i in sample(1:nrow(post_m4.prior), 100)){
abline(post_m4.prior[i,1],post_m4.prior[i,7], col=col.alpha("lightblue", 0.2), lwd=0.5)
}
plot(NULL, xlim=c(-3,3), ylim=c(0,1))
for(i in sample(1:nrow(post_m4.prior), 100)){
abline(logistic(post_m4.prior[i,1]),post_m4.prior[i,7], col=col.alpha("lightblue", 0.2), lwd=0.5)
}
summary(post_m4.prior[i,1])
summary(logistic(post_m4.prior[i,1])
)
summary(logistic(post_m4.prior[,1]))
plot(NULL, xlim=c(-3,3), ylim=c(-10,10))
for(i in sample(1:nrow(post_m4.prior), 100)){
abline(post_m4.prior[i,1],post_m4.prior[i,7], col=col.alpha("lightblue", 0.2), lwd=0.5)
}
logistic(-5)
logistic(5)
logistic(2)
m4<- brm(coalitions ~ Food_resource_defendable + Philopatry + SexDim.z + (1|Genus_species), data = d, family = categorical(), cov_ranef = list(Genus_species = A.cons),
prior = prior.m4, chains = 4, cores = 4, iter = 4000, warmup = 2000, control = list(adapt_delta = 0.999, max_treedepth = 15, stepsize = 0.01))
plot(m4) # good convergence, chains overlapping and stationary; some extreme values for sd's
summary(m4) # all Rhat 1, ESS >1000
# extract samples and save for post-processing
post_m4<- posterior_samples(m4)
save(post_m4, file="post_m4.robj")
m4a<- brm(coalitions ~ Food_resource_defendable + (1|Genus_species), data = d, family = categorical(), cov_ranef = list(Genus_species = A.cons),
prior = prior.m4, chains = 4, cores = 4, iter = 4000, warmup = 2000, control = list(adapt_delta = 0.999, max_treedepth = 15, stepsize = 0.01))
m4b<- brm(coalitions ~ Philopatry + (1|Genus_species), data = d, family = categorical(), cov_ranef = list(Genus_species = A.cons),
prior = prior.m4, chains = 4, cores = 4, iter = 4000, warmup = 2000, control = list(adapt_delta = 0.999, max_treedepth = 15, stepsize = 0.01))
m4c<- brm(coalitions ~ SexDim.z + (1|Genus_species), data = d, family = categorical(), cov_ranef = list(Genus_species = A.cons),
prior = prior.m4, chains = 4, cores = 4, iter = 4000, warmup = 2000, control = list(adapt_delta = 0.999, max_treedepth = 15, stepsize = 0.01))
post_m4a<- posterior_samples(m4a)
save(post_m4a, file="post_m4a.robj")
post_m4b<- posterior_samples(m4b)
save(post_m4b, file="post_m4b.robj")
post_m4c<- posterior_samples(m4c)
save(post_m4c, file="post_m4c.robj")
# no divergent transitions
plot(m4c)
summary(m4c)
# no divergent transitions
plot(m4b)
summary(m4b)
m4a<- brm(coalitions ~ Food_resource_defendable + (1|Genus_species), data = d, family = categorical(), cov_ranef = list(Genus_species = A.cons),
prior = prior.m4, chains = 4, cores = 4, iter = 5000, warmup = 3000, control = list(adapt_delta = 0.999, max_treedepth = 15, stepsize = 0.01))
# 40 divergent transitions
plot(m4a)
post_m4a<- posterior_samples(m4a)
save(post_m4a, file="post_m4a.robj")
summary(m4a)
