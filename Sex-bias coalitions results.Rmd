---
title: "Sex-bias coalitions results"
author: "Adrian Jaeggi"
date: "8 2 2022"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, include=FALSE, message=FALSE, warning=FALSE)
```

```{r loading}
 ## load relevant packages, set working directory, load saved model posteriors
library(brms)
library(rstan)
library(rethinking)
memory.limit(size=100000)
load("post_m1.robj")
load("post_m2.robj")
load("post_m3.robj")
load("post_m4.robj")
load("post_m4a.robj")
load("post_m4b.robj")
load("post_m4c.robj")
d<- read.csv("sexbiascoalitions.csv", header=TRUE)
d$Primate<- 0
d$Primate[d$Order=="Primata"]<- 1

```

```{r post-processing posteriors}
# calculate phylogenetic signal for Model 1
VarPhy.female<-post_m1$sd_Genus_species__muFemalebiased_Intercept
VarPhy.male<-post_m1$sd_Genus_species__muMalebiased_Intercept
VarDistro<- pi^2/3
lambda.m1<- (VarPhy.female+VarPhy.male)/(VarPhy.female+VarPhy.male+VarDistro)

# compute predicted probabilities for Model 1
{    K <- 3 #number of character states used
  ns <- nrow(post_m1)
  n <- 1
  
  softmax2 <- function(x) {
    x <- max(x) - x
    exp(-x)/sum(exp(-x))
  }
  
  p.m1 <- list()
  
  for ( i in 1:n ) {
    p.m1[[i]] <- sapply( 1:K , function(k) {
      if ( k < K ) {
        ptemp <- post_m1[,k] 
      } else {
        ptemp <- rep(0,ns)
      }
      return(ptemp)
    })
    ## The values are converted to probabilities using the softmax function
    ## which ensures that the predicted values across categories sum to
    ## 100% probabilities.
    for ( s in 1:ns ) p.m1[[i]][s,] <- softmax2( p.m1[[i]][s,] )
  }
}
p_median.m1 <- sapply( 1:length(p.m1) , function(i) apply(p.m1[[i]],2,median) )
p_HPDI.m1 <- sapply( 1:length(p.m1) , function(i) apply(p.m1[[i]],2,HPDI, prob=0.90) )
pred_probs_m1<- cbind(p_median.m1, p_HPDI.m1[c(1,3,5),], p_HPDI.m1[c(2,4,6),])

# probability of difference
diff.fm.m1<- p.m1[[1]][,1]-p.m1[[1]][,2]

```

Contrary to our first prediction, females did not cooperate more in within-group coalitions than males (Fig. 1, Model 1, see also supplement). In fact, the probability of a female bias in coalitions (median = `r round(pred_probs_m1,2)[1,1]`, 90% credible interval = `r round(pred_probs_m1,2)[1,2]` – `r round(pred_probs_m1,2)[1,3]`) was virtually the same as the probability of a male bias (`r round(pred_probs_m1,2)[2,1]`, `r round(pred_probs_m1,2)[2,2]` – `r round(pred_probs_m1,2)[2,3]`) and the most likely state was unbiased coalition formation (`r round(pred_probs_m1,2)[3,1]`, `r round(pred_probs_m1,2)[3,2]` – `r round(pred_probs_m1,2)[3,3]`). Thus, only `r round(100*sum(diff.fm.m1>0)/length(diff.fm.m1),0)`% of the posterior probability supports our prediction of female bias being more likely than male bias, and none of the three possible states was greater than chance (% of posterior > 0.33 for female bias: `r round(100*sum(p.m1[[1]][,1]>0.33)/length(p.m1[[1]][,1]),0)`%; male bias: `r round(100*sum(p.m1[[1]][,2]>0.33)/length(p.m1[[1]][,2]),0)`%; unbiased: `r round(100*sum(p.m1[[1]][,3]>0.33)/length(p.m1[[1]][,3]),0)`%). The phylogenetic signal was weak (median λ = `r round(median(lambda.m1),2)`, 90% CI = `r round(HPDI(lambda.m1, prob=0.90)[1],2)` – `r round(HPDI(lambda.m1, prob=0.90)[2],2)`)). 

This general pattern did not change appreciably when comparing species living in mixed-sex groups (n = `r length(d$SexComposition[d$SexComposition=="mixed"])` species) with sex-segregated ones (n = `r length(d$SexComposition[d$SexComposition=="segregated"])` species; Model 2), or primates (n= `r length(d$Primate[d$Primate==1])` species) with non-primates (n= `r length(d$Primate[d$Primate==0])` species; Model 3). Specifically, the odds of female bias and male bias were essentially the same in sex-segregated species compared to mixed-sex species (female bias: median odds ratio = `r round(median(exp(post_m2$b_muFemalebiased_SexCompositionsegregated)),2)`, 90% CI = `r round(HPDI(exp(post_m2$b_muFemalebiased_SexCompositionsegregated), prob=0.90)[1],2)` - `r round(HPDI(exp(post_m2$b_muFemalebiased_SexCompositionsegregated), prob=0.90)[2],2)`, probability OR>1 = `r round(100*sum(post_m2$b_muFemalebiased_SexCompositionsegregated>0)/nrow(post_m2),0)`%; male bias: median OR = `r round(median(exp(post_m2$b_muMalebiased_SexCompositionsegregated)),2)`, 90% CI = `r round(HPDI(exp(post_m2$b_muMalebiased_SexCompositionsegregated), prob=0.90)[1],2)` - `r round(HPDI(exp(post_m2$b_muMalebiased_SexCompositionsegregated), prob=0.90)[2],2)`, probability OR>1 = `r round(100*sum(post_m2$b_muMalebiased_SexCompositionsegregated>0)/nrow(post_m2),0)`%) or primates compared to non-primates (female bias: median odds ratio = `r round(median(exp(post_m3$b_muFemalebiased_Primate)),2)`, 90% CI = `r round(HPDI(exp(post_m3$b_muFemalebiased_Primate), prob=0.90)[1],2)` - `r round(HPDI(exp(post_m3$b_muFemalebiased_Primate), prob=0.90)[2],2)`, probability OR>1 = `r round(100*sum(post_m3$b_muFemalebiased_Primate>0)/nrow(post_m3),0)`%; male bias: median OR = `r round(median(exp(post_m3$b_muMalebiased_Primate)),2)`, 90% CI = `r round(HPDI(exp(post_m3$b_muMalebiased_Primate), prob=0.90)[1],2)` - `r round(HPDI(exp(post_m3$b_muMalebiased_Primate), prob=0.90)[2],2)`, probability OR>1 = `r round(100*sum(post_m3$b_muMalebiased_Primate>0)/nrow(post_m3),0)`%). We therefore did not stratify our subsequent analyses by these variables.

To test our socio-ecological predictors we included philopatry, sexual dimorphism, and food defensibility in the same model (Model 4). As a robustness check, we also modeled each of these competing causes on its own. In weak support of our predictions, the probability of female-biased coalitions was somewhat greater in female philopatric species, compared to species where both sexes disperse (OR = `r round(median(exp(post_m4$b_muFemalebiased_PhilopatryF)),2)`, 90% CI = `r round(HPDI(exp(post_m4$b_muFemalebiased_PhilopatryF), prob=0.90)[1],2)` - `r round(HPDI(exp(post_m4$b_muFemalebiased_PhilopatryF), prob=0.90)[2],2)`, probability OR>1 = `r round(100*sum(post_m4$b_muFemalebiased_PhilopatryF>0)/nrow(post_m4),0)`%), and in species with defensible food resources compared to species with non-defensible food resources (OR = `r round(median(exp(post_m4$b_muFemalebiased_Food_resource_defendable)),2)`, 90% CI = `r round(HPDI(exp(post_m4$b_muFemalebiased_Food_resource_defendable), prob=0.90)[1],2)` - `r round(HPDI(exp(post_m4$b_muFemalebiased_Food_resource_defendable), prob=0.90)[2],2)`, probability OR>1 = `r round(100*sum(post_m4$b_muFemalebiased_Food_resource_defendable>0)/nrow(post_m4),0)`%), though in both cases there was high uncertainty. Male bias in coalitions was not greater in species with male philopatry compared to species in which both sexes disperse (OR = `r round(median(exp(post_m4$b_muMalebiased_PhilopatryM)),2)`, 90% CI = `r round(HPDI(exp(post_m4$b_muMalebiased_PhilopatryM), prob=0.90)[1],2)` - `r round(HPDI(exp(post_m4$b_muMalebiased_PhilopatryM), prob=0.90)[2],2)`, probability OR>1 = `r round(100*sum(post_m4$b_muMalebiased_PhilopatryM>0)/nrow(post_m4),0)`%); however, as predicted the probability of male bias did increase with increasing sexual dimorphism (OR for 1SD change in dimorphism = `r round(median(exp(post_m4$b_muMalebiased_SexDim.z)),2)`, 90% CI = `r round(HPDI(exp(post_m4$b_muMalebiased_SexDim.z), prob=0.90)[1],2)` - `r round(HPDI(exp(post_m4$b_muMalebiased_SexDim.z), prob=0.90)[2],2)`, probability OR>1 = `r round(100*sum(post_m4$b_muMalebiased_SexDim.z>0)/nrow(post_m4),0)`%). These inferences did not change when considering each predictor in a model on its own (see Supplement).

